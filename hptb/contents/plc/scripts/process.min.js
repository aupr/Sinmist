var preprocess=function(){plcUserId="admin";plcPassword="";plcTag={vfd_start:'"Control".VFD_Control.Write_To_G120.Start',vfd_stop:'"Control".VFD_Control.Write_To_G120.Stop',vfd_frequency:'"Control".VFD_Control.Write_To_G120."Set Frequency"',emfm_1_minLimit:'"Control".Flow_Meters.Electro_Magnetic."1"."Min Limit"',emfm_1_maxLimit:'"Control".Flow_Meters.Electro_Magnetic."1"."Max Limit"',emfm_2_minLimit:'"Control".Flow_Meters.Electro_Magnetic."2"."Min Limit"',emfm_2_maxLimit:'"Control".Flow_Meters.Electro_Magnetic."2"."Max Limit"',emfm_3_minLimit:'"Control".Flow_Meters.Electro_Magnetic."3"."Min Limit"',emfm_3_maxLimit:'"Control".Flow_Meters.Electro_Magnetic."3"."Max Limit"',emfm_4_minLimit:'"Control".Flow_Meters.Electro_Magnetic."4"."Min Limit"',emfm_4_maxLimit:'"Control".Flow_Meters.Electro_Magnetic."4"."Max Limit"',usfm_1_minLimit:'"Control".Flow_Meters.Ultrasonic."1"."Min Limit"',usfm_1_maxLimit:'"Control".Flow_Meters.Ultrasonic."1"."Max Limit"',usfm_2_minLimit:'"Control".Flow_Meters.Ultrasonic."2"."Min Limit"',usfm_2_maxLimit:'"Control".Flow_Meters.Ultrasonic."2"."Max Limit"',kgv_1_position:'"Control".Knife_Gate_Valve."1".Input',kgv_2_position:'"Control".Knife_Gate_Valve."2".Input',kgv_3_position:'"Control".Knife_Gate_Valve."3".Input',kgv_4_position:'"Control".Knife_Gate_Valve."4".Input',pt_1_minLimit:'"Control".PressureTransmitters."1"."Min Limit"',pt_1_maxLimit:'"Control".PressureTransmitters."1"."Max Limit"',pt_2_minLimit:'"Control".PressureTransmitters."2"."Min Limit"',pt_2_maxLimit:'"Control".PressureTransmitters."2"."Max Limit"',pt_3_minLimit:'"Control".PressureTransmitters."3"."Min Limit"',pt_3_maxLimit:'"Control".PressureTransmitters."3"."Max Limit"',pt_4_minLimit:'"Control".PressureTransmitters."4"."Min Limit"',pt_4_maxLimit:'"Control".PressureTransmitters."4"."Max Limit"',pt_5_minLimit:'"Control".PressureTransmitters."5"."Min Limit"',pt_5_maxLimit:'"Control".PressureTransmitters."5"."Max Limit"',pt_6_minLimit:'"Control".PressureTransmitters."6"."Min Limit"',pt_6_maxLimit:'"Control".PressureTransmitters."6"."Max Limit"',pt_7_minLimit:'"Control".PressureTransmitters."7"."Min Limit"',pt_7_maxLimit:'"Control".PressureTransmitters."7"."Max Limit"',pt_8_minLimit:'"Control".PressureTransmitters."8"."Min Limit"',pt_8_maxLimit:'"Control".PressureTransmitters."8"."Max Limit"',pt_9_minLimit:'"Control".PressureTransmitters."9"."Min Limit"',pt_9_maxLimit:'"Control".PressureTransmitters."9"."Max Limit"',pt_10_minLimit:'"Control".PressureTransmitters."10"."Min Limit"',pt_10_maxLimit:'"Control".PressureTransmitters."10"."Max Limit"'};var a="Login="+plcUserId+"&Password="+plcPassword;$.post("/FormLogin",a,function(b){console.log("Access & Login PLC: Success")}).fail(function(){console.log("Access & Login PLC: Failed")});$("body").css({"background-color":"black"});$("nav .logo").css({"background-image":"url('"+server+"contents/images/logo.png')"});isProcess=0;window.onbeforeunload=function(){if(isProcess>0){return true}else{}}};var process=function(){var a={mode:"Auto",process:"Stopped",pipeDia:4,vp:56,nvp:59,frm:555,fru:555,motor:"Stopped",freq:50,rpm:1000,power:30,current:100};updateCurrentSystemStatus(a);bindButtons()};var mainData=[];function bindButtons(){$("#btn-settings").click(plcLimitSettings);$("#cb-start-process").click(startProcessHit);$("#cb-take-data").click(takeDataHit);$("#cb-emergency").click(emergencyHit);$("#setManualValvePosition").click(setManualValvePosition);$("#mib-motor-on").click(manualMotorOn);$("#mib-motor-off").click(manualMotorOff);$("#mib-take-status").click(manualUpdateStatus)}function disableControllerElements(a){$("input","#processMode").prop("disabled",a);$("#valveLowerLimit").prop("disabled",a);$("#valveUpperLimit").prop("disabled",a);$("#numberOfObs").prop("disabled",a);$("#ultrasonicSensorChannel").prop("disabled",a)}function disableManualElements(b){var a=$("#manualValvePosition");a.prop("disabled",b);hideElementById("setManualValvePosition",b);hideElementById("mib-motor-on",b);hideElementById("mib-motor-off",b);hideElementById("mib-take-status",b);if(!b){a.prop("min",$("#valveLowerLimit").val());a.prop("max",$("#valveUpperLimit").val());manualValvePosition=a.val();$("#setManualValvePosition span").text(manualValvePosition+"%");hideElementById("mib-motor-off",!b)}}function hideElementById(b,a){if(a){$("#"+b).css({display:"none"})}else{$("#"+b).css({display:"block"})}}var plcLimitSettings=function(){it_modal_loading();$.get("limit.html",function(b){var a='<table style="width: 100%;"><tbody><tr><td><label for="emfm-1-ll">EMFM-1 Lower Limit </label></td><td>:</td><td><input type="number" id="emfm-1-ll" value="'+b.emfm_1_minLimit+'"></td><td><label for="emfm-1-ul">EMFM-1 Upper Limit </label></td><td>:</td><td><input type="number" id="emfm-1-ul" value="'+b.emfm_1_maxLimit+'"></td></tr><tr><td><label for="emfm-2-ll">EMFM-2 Lower Limit </label></td><td>:</td><td><input type="number" id="emfm-2-ll" value="'+b.emfm_2_minLimit+'"></td><td><label for="emfm-2-ul">EMFM-2 Upper Limit </label></td><td>:</td><td><input type="number" id="emfm-2-ul" value="'+b.emfm_2_maxLimit+'"></td></tr><tr><td><label for="emfm-3-ll">EMFM-3 Lower Limit </label></td><td>:</td><td><input type="number" id="emfm-3-ll" value="'+b.emfm_3_minLimit+'"></td><td><label for="emfm-3-ul">EMFM-3 Upper Limit </label></td><td>:</td><td><input type="number" id="emfm-3-ul" value="'+b.emfm_3_maxLimit+'"></td></tr><tr><td><label for="emfm-4-ll">EMFM-4 Lower Limit </label></td><td>:</td><td><input type="number" id="emfm-4-ll" value="'+b.emfm_4_minLimit+'"></td><td><label for="emfm-4-ul">EMFM-4 Upper Limit </label></td><td>:</td><td><input type="number" id="emfm-4-ul" value="'+b.emfm_4_maxLimit+'"></td></tr><tr><td><label for="usfm-1-ll">USFM-1 Lower Limit </label></td><td>:</td><td><input type="number" id="usfm-1-ll" value="'+b.usfm_1_minLimit+'"></td><td><label for="usfm-1-ul">USFM-1 Upper Limit </label></td><td>:</td><td><input type="number" id="usfm-1-ul" value="'+b.usfm_1_maxLimit+'"></td></tr><tr><td><label for="usfm-2-ll">USFM-2 Lower Limit </label></td><td>:</td><td><input type="number" id="usfm-2-ll" value="'+b.usfm_2_minLimit+'"></td><td><label for="usfm-2-ul">USFM-2 Upper Limit </label></td><td>:</td><td><input type="number" id="usfm-2-ul" value="'+b.usfm_2_maxLimit+'"></td></tr><tr><td><label for="pt-1-ll">PT-1 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-1-ll" value="'+b.pt_1_minLimit+'"></td><td><label for="pt-1-ul">PT-1 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-1-ul" value="'+b.pt_1_maxLimit+'"></td></tr><tr><td><label for="pt-2-ll">PT-2 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-2-ll" value="'+b.pt_2_minLimit+'"></td><td><label for="pt-2-ul">PT-2 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-2-ul" value="'+b.pt_2_maxLimit+'"></td></tr><tr><td><label for="pt-3-ll">PT-3 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-3-ll" value="'+b.pt_3_minLimit+'"></td><td><label for="pt-3-ul">PT-3 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-3-ul" value="'+b.pt_3_maxLimit+'"></td></tr><tr><td><label for="pt-4-ll">PT-4 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-4-ll" value="'+b.pt_4_minLimit+'"></td><td><label for="pt-4-ul">PT-4 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-4-ul" value="'+b.pt_4_maxLimit+'"></td></tr><tr><td><label for="pt-5-ll">PT-5 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-5-ll" value="'+b.pt_5_minLimit+'"></td><td><label for="pt-5-ul">PT-5 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-5-ul" value="'+b.pt_5_maxLimit+'"></td></tr><tr><td><label for="pt-6-ll">PT-6 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-6-ll" value="'+b.pt_6_minLimit+'"></td><td><label for="pt-6-ul">PT-6 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-6-ul" value="'+b.pt_6_maxLimit+'"></td></tr><tr><td><label for="pt-7-ll">PT-7 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-7-ll" value="'+b.pt_7_minLimit+'"></td><td><label for="pt-7-ul">PT-7 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-7-ul" value="'+b.pt_7_maxLimit+'"></td></tr><tr><td><label for="pt-8-ll">PT-8 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-8-ll" value="'+b.pt_8_minLimit+'"></td><td><label for="pt-8-ul">PT-8 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-8-ul" value="'+b.pt_8_maxLimit+'"></td></tr><tr><td><label for="pt-9-ll">PT-9 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-9-ll" value="'+b.pt_9_minLimit+'"></td><td><label for="pt-9-ul">PT-9 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-9-ul" value="'+b.pt_9_maxLimit+'"></td></tr><tr><td><label for="pt-10-ll">PT-10 Lower Limit </label></td><td>:</td><td><input type="number" id="pt-10-ll" value="'+b.pt_10_minLimit+'"></td><td><label for="pt-10-ul">PT-10 Upper Limit </label></td><td>:</td><td><input type="number" id="pt-10-ul" value="'+b.pt_10_maxLimit+'"></td></tr></tbody></table>';it_modal_open("Sensors Data Limit Setup!",a,"dodgerblue","800px","Close, Save",function(c){if(c=="Save"){var d=plcTag.emfm_1_minLimit+"="+$("#emfm-1-ll").val()+"&"+plcTag.emfm_1_maxLimit+"="+$("#emfm-1-ul").val()+"&"+plcTag.emfm_2_minLimit+"="+$("#emfm-2-ll").val()+"&"+plcTag.emfm_2_maxLimit+"="+$("#emfm-2-ul").val()+"&"+plcTag.emfm_3_minLimit+"="+$("#emfm-3-ll").val()+"&"+plcTag.emfm_3_maxLimit+"="+$("#emfm-3-ul").val()+"&"+plcTag.emfm_4_minLimit+"="+$("#emfm-4-ll").val()+"&"+plcTag.emfm_4_maxLimit+"="+$("#emfm-4-ul").val()+"&"+plcTag.usfm_1_minLimit+"="+$("#usfm-1-ll").val()+"&"+plcTag.usfm_1_maxLimit+"="+$("#usfm-1-ul").val()+"&"+plcTag.usfm_2_minLimit+"="+$("#usfm-2-ll").val()+"&"+plcTag.usfm_2_maxLimit+"="+$("#usfm-2-ul").val()+"&"+plcTag.pt_1_minLimit+"="+$("#pt-1-ll").val()+"&"+plcTag.pt_1_maxLimit+"="+$("#pt-1-ul").val()+"&"+plcTag.pt_2_minLimit+"="+$("#pt-2-ll").val()+"&"+plcTag.pt_2_maxLimit+"="+$("#pt-2-ul").val();it_modal_loading();$.get("limit.html?"+d,function(){d=plcTag.pt_3_minLimit+"="+$("#pt-3-ll").val()+"&"+plcTag.pt_3_maxLimit+"="+$("#pt-3-ul").val()+"&"+plcTag.pt_4_minLimit+"="+$("#pt-4-ll").val()+"&"+plcTag.pt_4_maxLimit+"="+$("#pt-4-ul").val()+"&"+plcTag.pt_5_minLimit+"="+$("#pt-5-ll").val()+"&"+plcTag.pt_5_maxLimit+"="+$("#pt-5-ul").val()+"&"+plcTag.pt_6_minLimit+"="+$("#pt-6-ll").val()+"&"+plcTag.pt_6_maxLimit+"="+$("#pt-6-ul").val()+"&"+plcTag.pt_7_minLimit+"="+$("#pt-7-ll").val()+"&"+plcTag.pt_7_maxLimit+"="+$("#pt-7-ul").val()+"&"+plcTag.pt_8_minLimit+"="+$("#pt-8-ll").val()+"&"+plcTag.pt_8_maxLimit+"="+$("#pt-8-ul").val()+"&"+plcTag.pt_9_minLimit+"="+$("#pt-9-ll").val()+"&"+plcTag.pt_9_maxLimit+"="+$("#pt-9-ul").val()+"&"+plcTag.pt_10_minLimit+"="+$("#pt-10-ll").val()+"&"+plcTag.pt_10_maxLimit+"="+$("#pt-10-ul").val();$.get("limit.html?"+d,function(){it_modal_close()}).fail(function(){alert("PLC server is not responding at secondary step.")})}).fail(function(){alert("PLC server is not responding at primary step.")})}else{if(c=="Close"){it_modal_close()}}})},"json").fail(function(){alert("PLC communication failure.")})};var startProcessHit=function(){requestProgress("start");hideElementById("cb-start-process",true);disableControllerElements(true);var a="";$.get("data.html?"+a,function(b){requestProgress("end");processInfo.motorStatus="Stopped";processInfo.status="Running";processInfo.usfmChannel=$("#ultrasonicSensorChannel").val();if($('input[name="pmode"]:checked').val()==="manual"){disableManualElements(false);processInfo.mode="Manual"}else{processInfo.mode="Automatic"}hideElementById("cb-take-data",false);hideElementById("cb-emergency",false);updateCurrentSystemStatus(b)},"json").fail(function(){requestProgress("stop");hideElementById("cb-start-process",false);disableControllerElements(false);alert("PLC is not responding!")})};var takeDataHit=function(){if(processInfo.mode==="Manual"){if(dataTakePermission){dataTakePermission=false;updateDataAndView(statusHold)}else{it_modal_info("Already taken this data!")}}else{if(processInfo.mode==="Automatic"){}else{it_modal_info("Something going absurd!")}}};var emergencyHit=function(){requestProgress("start");hideElementById("cb-emergency",true);hideElementById("cb-take-data",true);$.get("data.html?"+plcTag.vfd_stop+"=1",function(a){requestProgress("end");processInfo.status="Stopped";processInfo.motorStatus="Stopped";disableManualElements(true);hideElementById("cb-start-process",false);disableControllerElements(false);updateCurrentSystemStatus(a);handleData()},"json").fail(function(){requestProgress("stop");hideElementById("cb-emergency",false);hideElementById("cb-take-data",false)})};var setManualValvePosition=function(){hideElementById("setManualValvePosition",true);requestProgress("start");var a="";if(pumpInfo.pipeDia===3){a=plcTag.kgv_1_position+"="+manualValvePosition}else{if(pumpInfo.pipeDia===4){a=plcTag.kgv_2_position+"="+manualValvePosition}else{if(pumpInfo.pipeDia===6){a=plcTag.kgv_3_position+"="+manualValvePosition}else{if(pumpInfo.pipeDia===8){a=plcTag.kgv_4_position+"="+manualValvePosition}}}}$.get("data.html?"+a,function(b){hideElementById("setManualValvePosition",false);requestProgress("end");updateCurrentSystemStatus(b)},"json").fail(function(){requestProgress("stop");hideElementById("setManualValvePosition",false);alert("PLC is not responding the request!")})};var manualMotorOn=function(){hideElementById("mib-motor-on",true);requestProgress("start");var a=plcTag.vfd_start+"=1";$.get("data.html?"+a,function(b){processInfo.motorStatus="Running";hideElementById("mib-motor-off",false);requestProgress("end");updateCurrentSystemStatus(b)},"json").fail(function(){requestProgress("stop");hideElementById("mib-motor-on",false);alert("PLC is not responding the request!")})};var manualMotorOff=function(){hideElementById("mib-motor-off",true);requestProgress("start");var a=plcTag.vfd_stop+"=1";$.get("data.html?"+a,function(b){processInfo.motorStatus="Stopped";hideElementById("mib-motor-on",false);requestProgress("end");updateCurrentSystemStatus(b)},"json").fail(function(){requestProgress("stop");hideElementById("mib-motor-off",false);alert("PLC is not responding the request!")})};var manualUpdateStatus=function(){hideElementById("mib-take-status",true);requestProgress("start");$.get("data.html",function(a){hideElementById("mib-take-status",false);updateCurrentSystemStatus(a);requestProgress("end")},"json").fail(function(){hideElementById("mib-take-status",false);requestProgress("stop")})};function vpProgressBar(a){$("#vpProgress").css({width:a+"%"})}function requestProgress(b){if(b==="start"){var a=0;ptimer=setInterval(function(){vpProgressBar(a++);if(a>=90){clearInterval(ptimer)}},300)}else{if(b==="stop"){clearInterval(ptimer)}else{if(b==="end"){clearInterval(ptimer);vpProgressBar(100)}}}}function targetSuctionPressureOnTypeDia(b,c,a){if(c==="Submersible Pump"){return 0}else{if(a===3){return b.pt_1_output}else{if(a===4){return b.pt_3_output}else{if(a===6){return b.pt_5_output}else{if(a===8){return b.pt_7_output}}}}}}function targetDischargePressureOnTypeDia(b,c,a){if(c==="Submersible Pump"){if(a===4){return b.pt_9_output}else{if(a===6){return b.pt_10_output}}}else{if(a===3){return b.pt_2_output}else{if(a===4){return b.pt_4_output}else{if(a===6){return b.pt_6_output}else{if(a===8){return b.pt_8_output}}}}}}function targetValvePositionOnDia(b,a){if(a===3){return b.kgv_1_position}else{if(a===4){return b.kgv_2_position}else{if(a===6){return b.kgv_3_position}else{if(a===8){return b.kgv_4_position}}}}}function targetMFlowRateOnDia(b,a){if(a===3){return b.emfm_1_output}else{if(a===4){return b.emfm_2_output}else{if(a===6){return b.emfm_3_output}else{if(a===8){return b.emfm_4_output}}}}}function targetUFlowRateOnDia(b,a){if(a==="1"){return b.usfm_1_output}else{if(a==="2"){return b.usfm_2_output}}}function updateDataTable(a){a.sort(function(d,c){return d.frm-c.frm});$("#dataViewTable").html("");a.forEach(function(c,b){b=b+1;$("#dataViewTable").append(" <tr><td>"+b+"</td><td>"+c.vo+"</td><td>"+c.sp+"</td><td>"+c.dp+"</td><td>"+c.frm+"</td><td>"+c.fru+"</td><td>"+c.men+"</td><td>"+c.mfq+"</td></tr>")})}mainData=[];function updateDataAndView(b){var a={vo:targetValvePositionOnDia(b,pumpInfo.pipeDia),sp:targetSuctionPressureOnTypeDia(b,pumpInfo.pumpType,pumpInfo.pipeDia),dp:targetDischargePressureOnTypeDia(b,pumpInfo.pumpType,pumpInfo.pipeDia),frm:targetMFlowRateOnDia(b,pumpInfo.pipeDia),fru:targetUFlowRateOnDia(b,processInfo.usfmChannel),men:b.vfd_power,mfq:b.vfd_frequency};var c=false;mainData.forEach(function(d){if(JSON.stringify(d)===JSON.stringify(a)){c=true}});if(c){it_modal_info("Already exists this data in data holder!")}else{mainData.push(a);updateDataTable(mainData);if(mainData.length>=$("#numberOfObs").val()){$("#cb-emergency").click()}}}function handleData(){if(mainData.length>0){var a="<b>What do you want with the data?</b>";it_modal_open("Observation Complete!",a,"#008800",0,"Save, Erase, Cancel",function(b){if(b==="Save"){alert("save")}else{if(b==="Erase"){mainData=[];updateDataTable(mainData);it_modal_close()}else{if("Cancel"){it_modal_close()}}}})}}statusHold={};dataTakePermission=false;function updateCurrentSystemStatus(b){statusHold=b;dataTakePermission=true;var a={mode:processInfo.mode,process:processInfo.status,pipeDia:pumpInfo.pipeDia,vp:targetValvePositionOnDia(b,pumpInfo.pipeDia),frm:targetMFlowRateOnDia(b,pumpInfo.pipeDia),fru:targetUFlowRateOnDia(b,processInfo.usfmChannel),sp:targetSuctionPressureOnTypeDia(b,pumpInfo.pumpType,pumpInfo.pipeDia),dp:targetDischargePressureOnTypeDia(b,pumpInfo.pumpType,pumpInfo.pipeDia),motor:processInfo.motorStatus,freq:b.vfd_frequency,rpm:b.vfd_rpm,power:b.vfd_power,current:b.vfd_current};$("#status-mode").html(a.mode);$("#status-process").html(a.process);$("#status-pipe-dia").html(a.pipeDia);$("#status-valve-position").html(a.vp);$("#mibCvp").html(a.vp);$("#status-flow-rate-m").html(a.frm);$("#status-flow-rate-u").html(a.fru);$("#status-next-vp").html(a.nvp);$("#status-suction-pressure").html(a.sp);$("#status-discharge-pressure").html(a.dp);$("#status-motor").html(a.motor);$("#status-freq").html(a.freq);$("#status-rpm").html(a.rpm);$("#status-power").html(a.power);$("#status-current").html(a.current)}function scrollUp(a){$(a).scrollTop(a.prop("scrollHeight"))}logLimit=5000;txt="";logNum=0;function systemLog(c){selector=$("#system-log");logNum++;var b=new Date();var a=b.getFullYear()+"-"+b.getMonth()+1+"-"+b.getDate()+" > "+b.getHours()+":"+b.getMinutes()+":"+b.getSeconds();if(txt===""){txt+=logNum+" > "+a+" > "+c}else{txt+="\r\n"+logNum+" > "+a+" > "+c}var d=txt.split("\r\n");sptLen=d.length;if(sptLen>logLimit){d=d.slice(sptLen-logLimit,sptLen)}txt=d.join("\r\n");selector.val(txt);scrollUp(selector)};